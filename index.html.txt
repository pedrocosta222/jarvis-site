<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JARVIS • CORE HUD</title>
  
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <style>
    :root {
      --bg0: #02050a;
      --bg1: #071426;
      --card: rgba(10, 30, 52, 0.7);
      --line: #13c2ff;
      --line2: #7de7ff;
      --ok: #38fbb5;
      --warn: #ffd37a;
      --bad: #ff5f77;
      --text: #d9f6ff;
      --muted: rgba(217, 246, 255, 0.7);
      --muted2: rgba(217, 246, 255, 0.4);
      --glow: rgba(19, 194, 255, 0.4);
      --r1: 18px;
      --r2: 12px;
      --mono: "JetBrains Mono", ui-monospace, monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, sans-serif;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; overflow: hidden; background: var(--bg0); }

    body {
      font-family: var(--sans);
      color: var(--text);
      background: 
        radial-gradient(circle at 50% 50%, rgba(19, 194, 255, 0.08), transparent 70%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
    }

    /* Grid de fundo estilo Sci-Fi */
    body::before {
      content: ""; position: fixed; inset: 0;
      background-image: 
        linear-gradient(to right, rgba(19, 194, 255, 0.05) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(19, 194, 255, 0.05) 1px, transparent 1px);
      background-size: 40px 40px;
      mask-image: radial-gradient(circle at 50% 50%, black, transparent 90%);
      pointer-events: none;
    }

    .wrap {
      display: grid;
      grid-template-columns: 300px 1fr 340px;
      gap: 15px;
      height: 100vh;
      padding: 15px;
    }

    .panel {
      border: 1px solid rgba(19, 194, 255, 0.2);
      background: var(--card);
      backdrop-filter: blur(10px);
      border-radius: var(--r1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    /* Header dos Painéis */
    .hdr {
      padding: 12px 15px;
      background: rgba(19, 194, 255, 0.1);
      border-bottom: 1px solid rgba(19, 194, 255, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .brand {
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: 2px;
      text-transform: uppercase;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--line); box-shadow: 0 0 10px var(--line); }
    .dot.pulse { animation: pulse 1.5s infinite; }

    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

    /* Estilo de Pills/Status */
    .pill {
      font-family: var(--mono);
      font-size: 9px;
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid rgba(19, 194, 255, 0.3);
      background: rgba(19, 194, 255, 0.05);
    }
    .pill.ok { color: var(--ok); border-color: var(--ok); }
    .pill.warn { color: var(--warn); border-color: var(--warn); }
    .pill.bad { color: var(--bad); border-color: var(--bad); }

    /* Área de Chat */
    .log { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
    
    .row { display: flex; width: 100%; }
    .bubble {
      max-width: 85%;
      padding: 12px 16px;
      border-radius: var(--r2);
      font-size: 14px;
      line-height: 1.5;
      position: relative;
      border: 1px solid rgba(19, 194, 255, 0.15);
      background: rgba(255, 255, 255, 0.03);
    }
    .bubble.me { margin-left: auto; background: rgba(19, 194, 255, 0.1); border-color: rgba(19, 194, 255, 0.3); }

    /* Markdown styling inside bubbles */
    .bubble p { margin: 0 0 10px 0; }
    .bubble p:last-child { margin: 0; }
    .bubble code { font-family: var(--mono); background: rgba(0,0,0,0.3); padding: 2px 4px; border-radius: 4px; color: var(--line2); }
    .bubble ul { padding-left: 20px; margin: 5px 0; }

    .meta { font-family: var(--mono); font-size: 9px; color: var(--muted2); margin-top: 6px; text-transform: uppercase; }

    /* Input Composer */
    .composer { padding: 15px; border-top: 1px solid rgba(19, 194, 255, 0.15); display: flex; gap: 10px; background: rgba(0,0,0,0.2); }
    textarea {
      flex: 1; background: rgba(0,0,0,0.3); border: 1px solid rgba(19, 194, 255, 0.2);
      border-radius: 8px; padding: 12px; color: white; outline: none; resize: none; font-family: var(--sans);
    }
    textarea:focus { border-color: var(--line); }

    .btn {
      background: var(--line); color: var(--bg0); border: none; border-radius: 8px;
      padding: 0 20px; font-weight: bold; font-family: var(--mono); cursor: pointer;
      transition: 0.2s; font-size: 11px;
    }
    .btn:hover { background: var(--line2); transform: scale(1.02); }
    .btn:disabled { opacity: 0.5; filter: grayscale(1); }

    /* Cards Laterais */
    .side-content { padding: 15px; display: flex; flex-direction: column; gap: 15px; }
    .card { background: rgba(0,0,0,0.2); border: 1px solid rgba(19, 194, 255, 0.1); padding: 12px; border-radius: 10px; }
    .card h4 { margin: 0 0 10px 0; font-family: var(--mono); font-size: 10px; color: var(--line); text-transform: uppercase; }
    
    input {
      width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(19, 194, 255, 0.2);
      padding: 8px; border-radius: 5px; color: white; font-size: 12px; margin-bottom: 8px;
    }

    .typing { display: flex; gap: 4px; padding: 5px; }
    .typing span { width: 5px; height: 5px; background: var(--line); border-radius: 50%; animation: blink 1s infinite; }
    @keyframes blink { 0%, 100% { opacity: 0.2; } 50% { opacity: 1; } }

    @media (max-width: 1000px) {
      .wrap { grid-template-columns: 1fr; overflow-y: auto; height: auto; }
      .panel { min-height: 400px; }
    }
  </style>
</head>
<body>

<div class="wrap">
  <div class="panel">
    <div class="hdr">
      <div class="brand"><span class="dot"></span> SYSTEM ANALYTICS</div>
    </div>
    <div class="side-content">
      <div class="card">
        <h4>Sessão Ativa</h4>
        <div id="sessId" style="font-family: var(--mono); font-size: 10px; color: var(--muted);">ID: ---</div>
      </div>
      <div class="card">
        <h4>Quick Commands</h4>
        <button class="btn" style="width:100%; margin-bottom:5px; padding:10px;" onclick="setCmd('/resumo')">RESUMO</button>
        <button class="btn" style="width:100%; margin-bottom:5px; padding:10px;" onclick="setCmd('/analise')">ANÁLISE VÍDEO</button>
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="hdr">
      <div class="brand"><span class="dot pulse"></span> JARVIS CORE</div>
      <div style="display:flex; gap:10px;">
        <span id="statusPill" class="pill ok">ONLINE</span>
        <span id="latencyPill" class="pill">0ms</span>
      </div>
    </div>
    
    <div class="log" id="log"></div>

    <div class="composer">
      <textarea id="q" placeholder="Aguardando diretrizes..." rows="1"></textarea>
      <button class="btn" id="sendBtn">EXECUTE</button>
    </div>
  </div>

  <div class="panel">
    <div class="hdr">
      <div class="brand">USER DATA</div>
      <span class="pill warn">ENCRYPTED</span>
    </div>
    <div class="side-content">
      <div class="card">
        <h4>Credenciais</h4>
        <input type="text" id="userName" placeholder="Nome do Agente">
        <input type="text" id="userEmail" placeholder="Email de Acesso">
      </div>
      <div class="card">
        <h4>Logs de Saída</h4>
        <div id="debugLog" style="font-family: var(--mono); font-size: 9px; color: var(--muted); height: 100px; overflow-y: auto;">
          > Initializing core...<br>
          > Handshake ready.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // CONFIGURAÇÃO DO WEBHOOK
  const WEBHOOK_URL = "https://webhook.dev.servicosdigitaispdr.shop/webhook/jarvis";

  const logEl = document.getElementById('log');
  const qEl = document.getElementById('q');
  const sendBtn = document.getElementById('sendBtn');
  const debugEl = document.getElementById('debugLog');

  // Gerar Session ID
  const sessionId = "SESS-" + Math.random().toString(36).substr(2, 9).toUpperCase();
  document.getElementById('sessId').textContent = "ID: " + sessionId;

  function addDebug(msg) {
    debugEl.innerHTML += `> ${msg}<br>`;
    debugEl.scrollTop = debugEl.scrollHeight;
  }

  function setCmd(cmd) {
    qEl.value = cmd + " ";
    qEl.focus();
  }

  // Função de Voz (JARVIS)
  function speak(text) {
    if (!window.speechSynthesis) return;
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'pt-BR';
    u.rate = 1.1;
    u.onstart = () => document.getElementById('statusPill').textContent = "SPEAKING";
    u.onend = () => document.getElementById('statusPill').textContent = "ONLINE";
    window.speechSynthesis.speak(u);
  }

  function addBubble(text, who = 'ai') {
    const row = document.createElement('div');
    row.className = 'row';
    
    const bubble = document.createElement('div');
    bubble.className = `bubble ${who === 'me' ? 'me' : ''}`;
    
    if (who === 'ai') {
      bubble.innerHTML = marked.parse(text); // Converte Markdown para HTML
      speak(text.replace(/[*#`]/g, ""));    // Fala o texto limpo
    } else {
      bubble.textContent = text;
    }

    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.textContent = (who === 'ai' ? 'JARVIS' : 'USER') + " • " + new Date().toLocaleTimeString();
    
    bubble.appendChild(meta);
    row.appendChild(bubble);
    logEl.appendChild(row);
    logEl.scrollTo({ top: logEl.scrollHeight, behavior: 'smooth' });
  }

  async function execute() {
    const text = qEl.value.trim();
    if (!text || sendBtn.disabled) return;

    addBubble(text, 'me');
    qEl.value = "";
    sendBtn.disabled = true;
    addDebug("Awaiting Webhook response...");
    
    const startTime = performance.now();

    try {
      const response = await fetch(WEBHOOK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          chatInput: text,
          sessionId: sessionId,
          user: {
            name: document.getElementById('userName').value || "Unknown",
            email: document.getElementById('userEmail').value || "N/A"
          }
        })
      });

      const data = await response.json();
      const endTime = performance.now();
      
      // Cálculo de latência
      document.getElementById('latencyPill').textContent = Math.round(endTime - startTime) + "ms";

      // Pega a resposta do n8n (tenta campos comuns: output, answer ou text)
      const aiMsg = data.output || data.answer || data.text || JSON.stringify(data);
      
      addBubble(aiMsg, 'ai');
      addDebug("Response received successfully.");

    } catch (err) {
      addBubble("⚠️ **ERRO CRÍTICO:** Falha na conexão com o Core.", 'ai');
      addDebug("Error: " + err.message);
    } finally {
      sendBtn.disabled = false;
    }
  }

  // Listeners
  sendBtn.addEventListener('click', execute);
  qEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      execute();
    }
  });

  // Mensagem Inicial
  window.onload = () => {
    addBubble("Sistemas carregados. Aguardando entrada de dados para processamento.", 'ai');
  };
</script>

</body>
</html>